export const setUserHue = async (hue: number) => {
  setCssVariables(hue);
  if (Trainer.connected()) {
    await Trainer.setColor(hslToRgbInt(hue, 0.5, 0.5));
  }
};

window.setUserHue = setUserHue;

function setCssVariables(hue: number) {
  let secondaryHue;

  if (hue < 20) {
    secondaryHue = hue / 2 + 40;
  } else if (hue > 320) {
    secondaryHue = (hue - 360) / 2 + 40;
  } else if (hue < 50) {
    secondaryHue = (hue - 40) * 2;
  } else if (hue < 110) {
    secondaryHue = hue + 60;
  } else if (hue < 170) {
    secondaryHue = hue - 60;
  } else if (hue < 245) {
    secondaryHue = hue + 75;
  } else {
    secondaryHue = hue - 75;
  }

  secondaryHue += 360;
  secondaryHue %= 360;

  let styleTag = document.querySelector("#user-colors");
  if (!styleTag) {
    styleTag = document.createElement("style");
    styleTag.id = "user-colors";
    document.head.appendChild(styleTag);
  }

  styleTag.innerHTML = `:root{${shadesToVariables(
    "primary",
    getShadesForHue(hue)
  )};${shadesToVariables("secondary", getShadesForHue(secondaryHue))}}`;
}

function hslToRgbInt(h: number, s: number, l: number): number {
  let r: number, g: number, b: number;

  if (s == 0) {
    r = g = b = l;
  } else {
    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
    const p = 2 * l - q;
    r = hue2rgb(p, q, h + 1 / 3);
    g = hue2rgb(p, q, h);
    b = hue2rgb(p, q, h - 1 / 3);
  }

  return (
    ((Math.round(r * 255) << 16) |
      (Math.round(g * 255) << 8) |
      Math.round(b * 255)) >>>
    0
  );
}

const hue2rgb = (p: number, q: number, t: number) => {
  if (t < 0) t += 1;
  if (t > 1) t -= 1;
  if (t < 1 / 6) return p + (q - p) * 6 * t;
  if (t < 1 / 2) return q;
  if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
  return p;
};

function shadesToVariables(name, shades) {
  return shades
    .map(
      (hsl, index) =>
        `--${name}-${index == 0 ? 50 : index * 100}: ${HSLToString(hsl)}`
    )
    .join(";\n");
}

function getShadesForHue(hue) {
  const gtIndex = ((x) => (x < 0 ? 0 : x))(hues.findIndex((h) => h > hue));
  const ltIndex = gtIndex === 0 ? hues.length - 1 : gtIndex - 1;
  const gtHue = hues[gtIndex];
  const ltHue = hues[ltIndex];
  const diff = gtHue - ltHue;
  const percent = (hue - ltHue) / diff;
  const gtShades = colorsHSL[colorNamesByHue[gtHue]];
  const ltShades = colorsHSL[colorNamesByHue[ltHue]];
  const shades = [];

  if (!gtShades) {
    console.log("missing hue:", hue, gtHue, gtIndex);
  }

  for (let i = 0; i < gtShades.length; i++) {
    shades.push(getHSLMixed(ltShades[i], gtShades[i], percent));
  }

  return shades;
}

function getHSLMixed(lt, gt, percent) {
  return {
    h: getMixed(lt.h, gt.h, percent),
    s: getMixed(lt.s, gt.s, percent),
    l: getMixed(lt.l, gt.l, percent),
  };
}

function getMixed(low, high, percent) {
  return low + (high - low) * percent;
}

function HSLToString({ h, s, l }) {
  h = Math.round(h);
  s = +(s * 100).toFixed(1);
  l = +(l * 100).toFixed(1);

  return h + " " + s + "% " + l + "%";
}

const colorsHSL = {
  Red: [
    {
      h: 0,
      s: 0.8571428571428578,
      l: 0.9725490196078431,
    },
    {
      h: 0,
      s: 0.9333333333333336,
      l: 0.9411764705882353,
    },
    {
      h: 0,
      s: 0.9629629629629626,
      l: 0.8941176470588235,
    },
    {
      h: 0,
      s: 0.9354838709677419,
      l: 0.8176470588235294,
    },
    {
      h: 0,
      s: 0.9060402684563756,
      l: 0.7078431372549019,
    },
    {
      h: 0,
      s: 0.8423645320197044,
      l: 0.6019607843137255,
    },
    {
      h: 0,
      s: 0.7222222222222222,
      l: 0.5058823529411764,
    },
    {
      h: 0,
      s: 0.7370892018779344,
      l: 0.41764705882352937,
    },
    {
      h: 0,
      s: 0.7000000000000001,
      l: 0.3529411764705882,
    },
    {
      h: 0,
      s: 0.6282051282051282,
      l: 0.3058823529411765,
    },
  ],
  Orange: [
    {
      h: 33,
      s: 1,
      l: 0.9647058823529412,
    },
    {
      h: 34,
      s: 1.0000000000000007,
      l: 0.9176470588235295,
    },
    {
      h: 32,
      s: 0.9767441860465114,
      l: 0.8313725490196078,
    },
    {
      h: 31,
      s: 0.9716312056737589,
      l: 0.7235294117647059,
    },
    {
      h: 27,
      s: 0.9597989949748742,
      l: 0.6098039215686274,
    },
    {
      h: 25,
      s: 0.9497907949790795,
      l: 0.5313725490196078,
    },
    {
      h: 21,
      s: 0.902439024390244,
      l: 0.48235294117647054,
    },
    {
      h: 17,
      s: 0.8834951456310678,
      l: 0.403921568627451,
    },
    {
      h: 15,
      s: 0.7906976744186047,
      l: 0.3372549019607843,
    },
    {
      h: 15,
      s: 0.7464788732394365,
      l: 0.2784313725490196,
    },
  ],
  Amber: [
    {
      h: 48,
      s: 0.9999999999999986,
      l: 0.9607843137254901,
    },
    {
      h: 48,
      s: 0.964912280701754,
      l: 0.888235294117647,
    },
    {
      h: 48,
      s: 0.9663865546218486,
      l: 0.7666666666666666,
    },
    {
      h: 46,
      s: 0.9668508287292819,
      l: 0.6450980392156863,
    },
    {
      h: 43,
      s: 0.9641255605381165,
      l: 0.5627450980392157,
    },
    {
      h: 38,
      s: 0.9212598425196851,
      l: 0.5019607843137255,
    },
    {
      h: 32,
      s: 0.9461883408071748,
      l: 0.4372549019607843,
    },
    {
      h: 26,
      s: 0.9047619047619048,
      l: 0.37058823529411766,
    },
    {
      h: 23,
      s: 0.825,
      l: 0.3137254901960784,
    },
    {
      h: 22,
      s: 0.7777777777777777,
      l: 0.2647058823529412,
    },
  ],
  Yellow: [
    {
      h: 55,
      s: 0.9166666666666659,
      l: 0.9529411764705882,
    },
    {
      h: 55,
      s: 0.9672131147540984,
      l: 0.8803921568627451,
    },
    {
      h: 53,
      s: 0.9830508474576269,
      l: 0.7686274509803921,
    },
    {
      h: 50,
      s: 0.9784946236559139,
      l: 0.6352941176470588,
    },
    {
      h: 48,
      s: 0.9581589958158995,
      l: 0.5313725490196078,
    },
    {
      h: 45,
      s: 0.9338842975206612,
      l: 0.4745098039215686,
    },
    {
      h: 41,
      s: 0.9611650485436892,
      l: 0.403921568627451,
    },
    {
      h: 35,
      s: 0.9166666666666666,
      l: 0.32941176470588235,
    },
    {
      h: 32,
      s: 0.8095238095238094,
      l: 0.2882352941176471,
    },
    {
      h: 28,
      s: 0.7251908396946566,
      l: 0.2568627450980392,
    },
  ],
  Lime: [
    {
      h: 78,
      s: 0.9199999999999993,
      l: 0.9509803921568627,
    },
    {
      h: 80,
      s: 0.8909090909090909,
      l: 0.892156862745098,
    },
    {
      h: 81,
      s: 0.8846153846153847,
      l: 0.7960784313725491,
    },
    {
      h: 82,
      s: 0.8452380952380951,
      l: 0.6705882352941176,
    },
    {
      h: 83,
      s: 0.7797356828193833,
      l: 0.5549019607843138,
    },
    {
      h: 84,
      s: 0.8053097345132743,
      l: 0.4431372549019608,
    },
    {
      h: 85,
      s: 0.8522727272727272,
      l: 0.34509803921568627,
    },
    {
      h: 86,
      s: 0.7841726618705036,
      l: 0.2725490196078431,
    },
    {
      h: 86,
      s: 0.689655172413793,
      l: 0.2274509803921569,
    },
    {
      h: 88,
      s: 0.6116504854368933,
      l: 0.2019607843137255,
    },
  ],
  Green: [
    {
      h: 138,
      s: 0.764705882352942,
      l: 0.9666666666666667,
    },
    {
      h: 141,
      s: 0.8421052631578952,
      l: 0.9254901960784314,
    },
    {
      h: 141,
      s: 0.7894736842105263,
      l: 0.8509803921568627,
    },
    {
      h: 142,
      s: 0.7664233576642338,
      l: 0.7313725490196079,
    },
    {
      h: 142,
      s: 0.6915887850467289,
      l: 0.5803921568627451,
    },
    {
      h: 142,
      s: 0.7056277056277057,
      l: 0.45294117647058824,
    },
    {
      h: 142,
      s: 0.762162162162162,
      l: 0.3627450980392157,
    },
    {
      h: 142,
      s: 0.7181208053691275,
      l: 0.29215686274509806,
    },
    {
      h: 143,
      s: 0.6422764227642277,
      l: 0.24117647058823527,
    },
    {
      h: 144,
      s: 0.6116504854368933,
      l: 0.2019607843137255,
    },
  ],
  Emerald: [
    {
      h: 152,
      s: 0.8095238095238101,
      l: 0.9588235294117647,
    },
    {
      h: 149,
      s: 0.8039215686274502,
      l: 0.8999999999999999,
    },
    {
      h: 152,
      s: 0.76,
      l: 0.803921568627451,
    },
    {
      h: 156,
      s: 0.7159763313609468,
      l: 0.6686274509803922,
    },
    {
      h: 158,
      s: 0.6437246963562753,
      l: 0.5156862745098039,
    },
    {
      h: 160,
      s: 0.8407960199004975,
      l: 0.3941176470588235,
    },
    {
      h: 161,
      s: 0.9354838709677418,
      l: 0.303921568627451,
    },
    {
      h: 163,
      s: 0.9354838709677419,
      l: 0.24313725490196078,
    },
    {
      h: 163,
      s: 0.8811881188118811,
      l: 0.19803921568627453,
    },
    {
      h: 164,
      s: 0.857142857142857,
      l: 0.1647058823529412,
    },
  ],
  Teal: [
    {
      h: 166,
      s: 0.764705882352942,
      l: 0.9666666666666667,
    },
    {
      h: 167,
      s: 0.8545454545454536,
      l: 0.892156862745098,
    },
    {
      h: 168,
      s: 0.8378378378378379,
      l: 0.7823529411764706,
    },
    {
      h: 171,
      s: 0.769230769230769,
      l: 0.6431372549019607,
    },
    {
      h: 172,
      s: 0.6600790513833992,
      l: 0.503921568627451,
    },
    {
      h: 173,
      s: 0.8039215686274509,
      l: 0.4,
    },
    {
      h: 175,
      s: 0.8385093167701863,
      l: 0.31568627450980397,
    },
    {
      h: 175,
      s: 0.7744360902255639,
      l: 0.2607843137254902,
    },
    {
      h: 176,
      s: 0.6936936936936937,
      l: 0.21764705882352942,
    },
    {
      h: 176,
      s: 0.6082474226804124,
      l: 0.19019607843137257,
    },
  ],
  Cyan: [
    {
      h: 183,
      s: 1,
      l: 0.9627450980392157,
    },
    {
      h: 185,
      s: 0.9591836734693879,
      l: 0.903921568627451,
    },
    {
      h: 186,
      s: 0.9354838709677419,
      l: 0.8176470588235294,
    },
    {
      h: 187,
      s: 0.9240506329113923,
      l: 0.6901960784313725,
    },
    {
      h: 188,
      s: 0.8571428571428572,
      l: 0.5333333333333333,
    },
    {
      h: 189,
      s: 0.9449541284403669,
      l: 0.4274509803921569,
    },
    {
      h: 192,
      s: 0.9139784946236559,
      l: 0.36470588235294116,
    },
    {
      h: 193,
      s: 0.8227848101265822,
      l: 0.30980392156862746,
    },
    {
      h: 194,
      s: 0.6956521739130435,
      l: 0.27058823529411763,
    },
    {
      h: 196,
      s: 0.6363636363636365,
      l: 0.2372549019607843,
    },
  ],
  Sky: [
    {
      h: 204,
      s: 1,
      l: 0.9705882352941176,
    },
    {
      h: 204,
      s: 0.9375000000000002,
      l: 0.9372549019607843,
    },
    {
      h: 201,
      s: 0.9436619718309865,
      l: 0.8607843137254902,
    },
    {
      h: 199,
      s: 0.954887218045113,
      l: 0.7392156862745098,
    },
    {
      h: 198,
      s: 0.9320388349514562,
      l: 0.596078431372549,
    },
    {
      h: 199,
      s: 0.8866396761133603,
      l: 0.4843137254901961,
    },
    {
      h: 200,
      s: 0.9800995024875623,
      l: 0.3941176470588235,
    },
    {
      h: 201,
      s: 0.9634146341463415,
      l: 0.32156862745098036,
    },
    {
      h: 201,
      s: 0.8999999999999999,
      l: 0.27450980392156865,
    },
    {
      h: 202,
      s: 0.8032786885245901,
      l: 0.23921568627450981,
    },
  ],
  Blue: [
    {
      h: 214,
      s: 1,
      l: 0.9686274509803922,
    },
    {
      h: 214,
      s: 0.9459459459459468,
      l: 0.9274509803921569,
    },
    {
      h: 213,
      s: 0.9692307692307693,
      l: 0.8725490196078431,
    },
    {
      h: 212,
      s: 0.9636363636363637,
      l: 0.7843137254901961,
    },
    {
      h: 213,
      s: 0.9390243902439025,
      l: 0.6784313725490196,
    },
    {
      h: 217,
      s: 0.9121951219512195,
      l: 0.5980392156862745,
    },
    {
      h: 221,
      s: 0.8319327731092436,
      l: 0.5333333333333333,
    },
    {
      h: 224,
      s: 0.7632653061224489,
      l: 0.4803921568627451,
    },
    {
      h: 226,
      s: 0.7073170731707317,
      l: 0.4019607843137255,
    },
    {
      h: 224,
      s: 0.6428571428571428,
      l: 0.32941176470588235,
    },
  ],
  Indigo: [
    {
      h: 226,
      s: 1,
      l: 0.9666666666666667,
    },
    {
      h: 226,
      s: 1,
      l: 0.9392156862745098,
    },
    {
      h: 228,
      s: 0.964912280701754,
      l: 0.888235294117647,
    },
    {
      h: 230,
      s: 0.9354838709677419,
      l: 0.8176470588235294,
    },
    {
      h: 234,
      s: 0.8947368421052633,
      l: 0.7392156862745098,
    },
    {
      h: 239,
      s: 0.8352941176470587,
      l: 0.6666666666666666,
    },
    {
      h: 243,
      s: 0.7535545023696683,
      l: 0.5862745098039216,
    },
    {
      h: 245,
      s: 0.5793650793650793,
      l: 0.5058823529411764,
    },
    {
      h: 244,
      s: 0.5450236966824644,
      l: 0.4137254901960784,
    },
    {
      h: 242,
      s: 0.4742857142857142,
      l: 0.3431372549019608,
    },
  ],
  Violet: [
    {
      h: 250,
      s: 1,
      l: 0.9764705882352941,
    },
    {
      h: 251,
      s: 0.9130434782608687,
      l: 0.9549019607843137,
    },
    {
      h: 251,
      s: 0.9523809523809532,
      l: 0.9176470588235295,
    },
    {
      h: 252,
      s: 0.9473684210526321,
      l: 0.8509803921568628,
    },
    {
      h: 255,
      s: 0.9173553719008263,
      l: 0.7627450980392156,
    },
    {
      h: 258,
      s: 0.8953488372093024,
      l: 0.6627450980392157,
    },
    {
      h: 262,
      s: 0.8325581395348839,
      l: 0.5784313725490197,
    },
    {
      h: 263,
      s: 0.6996047430830039,
      l: 0.503921568627451,
    },
    {
      h: 263,
      s: 0.6930232558139535,
      l: 0.4215686274509804,
    },
    {
      h: 264,
      s: 0.6741573033707865,
      l: 0.3490196078431373,
    },
  ],
  Purple: [
    {
      h: 270,
      s: 1.0000000000000029,
      l: 0.9803921568627452,
    },
    {
      h: 269,
      s: 0.9999999999999988,
      l: 0.9549019607843137,
    },
    {
      h: 269,
      s: 1.0000000000000007,
      l: 0.9176470588235295,
    },
    {
      h: 269,
      s: 0.9736842105263163,
      l: 0.8509803921568628,
    },
    {
      h: 270,
      s: 0.9523809523809523,
      l: 0.7529411764705882,
    },
    {
      h: 271,
      s: 0.9101123595505618,
      l: 0.6509803921568628,
    },
    {
      h: 271,
      s: 0.8133333333333332,
      l: 0.5588235294117647,
    },
    {
      h: 272,
      s: 0.7166666666666667,
      l: 0.47058823529411764,
    },
    {
      h: 273,
      s: 0.6716417910447762,
      l: 0.3941176470588235,
    },
    {
      h: 274,
      s: 0.6564417177914111,
      l: 0.3196078431372549,
    },
  ],
  Fuchsia: [
    {
      h: 289,
      s: 1.0000000000000027,
      l: 0.9784313725490197,
    },
    {
      h: 287,
      s: 0.9999999999999988,
      l: 0.9549019607843137,
    },
    {
      h: 288,
      s: 0.9583333333333335,
      l: 0.9058823529411765,
    },
    {
      h: 291,
      s: 0.9310344827586207,
      l: 0.8294117647058823,
    },
    {
      h: 292,
      s: 0.9142857142857141,
      l: 0.7254901960784313,
    },
    {
      h: 292,
      s: 0.8407960199004977,
      l: 0.6058823529411765,
    },
    {
      h: 293,
      s: 0.6947791164658634,
      l: 0.48823529411764705,
    },
    {
      h: 295,
      s: 0.7241379310344827,
      l: 0.39803921568627454,
    },
    {
      h: 295,
      s: 0.7023809523809524,
      l: 0.32941176470588235,
    },
    {
      h: 297,
      s: 0.6363636363636362,
      l: 0.2803921568627451,
    },
  ],
  Pink: [
    {
      h: 327,
      s: 0.7333333333333344,
      l: 0.9705882352941176,
    },
    {
      h: 326,
      s: 0.7777777777777777,
      l: 0.9470588235294117,
    },
    {
      h: 326,
      s: 0.8461538461538451,
      l: 0.8980392156862744,
    },
    {
      h: 327,
      s: 0.8709677419354838,
      l: 0.8176470588235294,
    },
    {
      h: 329,
      s: 0.855263157894737,
      l: 0.7019607843137255,
    },
    {
      h: 330,
      s: 0.811881188118812,
      l: 0.603921568627451,
    },
    {
      h: 333,
      s: 0.7142857142857142,
      l: 0.5058823529411764,
    },
    {
      h: 335,
      s: 0.7757009345794392,
      l: 0.4196078431372549,
    },
    {
      h: 336,
      s: 0.7444444444444445,
      l: 0.35294117647058826,
    },
    {
      h: 336,
      s: 0.6903225806451613,
      l: 0.30392156862745096,
    },
  ],
  Rose: [
    {
      h: 356,
      s: 1,
      l: 0.9725490196078431,
    },
    {
      h: 356,
      s: 0.999999999999999,
      l: 0.9470588235294117,
    },
    {
      h: 353,
      s: 0.9607843137254903,
      l: 0.9,
    },
    {
      h: 353,
      s: 0.9569892473118278,
      l: 0.8176470588235294,
    },
    {
      h: 351,
      s: 0.9452054794520545,
      l: 0.7137254901960783,
    },
    {
      h: 350,
      s: 0.891625615763547,
      l: 0.6019607843137256,
    },
    {
      h: 347,
      s: 0.7716535433070866,
      l: 0.4980392156862745,
    },
    {
      h: 345,
      s: 0.826923076923077,
      l: 0.40784313725490196,
    },
    {
      h: 343,
      s: 0.7966101694915255,
      l: 0.34705882352941175,
    },
    {
      h: 342,
      s: 0.7548387096774194,
      l: 0.30392156862745096,
    },
  ],
};

const colorNamesByHue = Object.keys(colorsHSL).reduce((lookup, name) => {
  lookup[colorsHSL[name][5].h] = name;
  return lookup;
}, {});
const hues = Object.keys(colorNamesByHue)
  .map((h) => parseInt(h))
  .sort((a, b) => a - b);
